<!DOCTYPE html>
<html>
<head>
  <title>OAuth Callback</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container {
      text-align: center;
      padding: 2rem;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .error { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner" id="spinner"></div>
    <p id="status">Completing sign-in...</p>
  </div>
  <script>
    // Extract code or error from URL
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const error = params.get('error');
    const errorDescription = params.get('error_description');

    const statusEl = document.getElementById('status');
    const spinnerEl = document.getElementById('spinner');

    // Store result in localStorage for main window to pick up
    // This approach works even when window.opener is lost (cross-origin navigation)
    if (error) {
      localStorage.setItem('oauth_result', JSON.stringify({
        type: 'error',
        error,
        errorDescription,
        timestamp: Date.now()
      }));
      spinnerEl.style.display = 'none';
      statusEl.innerHTML = `<span class="error">Authentication failed: ${errorDescription || error}</span>`;
      setTimeout(() => window.close(), 2000);
    } else if (code) {
      localStorage.setItem('oauth_result', JSON.stringify({
        type: 'success',
        code,
        timestamp: Date.now()
      }));
      statusEl.textContent = 'Success! Closing...';
      setTimeout(() => window.close(), 500);
    } else {
      spinnerEl.style.display = 'none';
      statusEl.innerHTML = '<span class="error">No authorization code received</span>';
    }

    // Also try postMessage as fallback (works in some browsers)
    if (window.opener) {
      try {
        window.opener.postMessage(
          { type: 'microsoft-oauth-callback', code, error, errorDescription },
          window.location.origin
        );
      } catch (e) {
        console.log('postMessage fallback failed:', e);
      }
    }
  </script>
</body>
</html>
